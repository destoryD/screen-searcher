name: æ„å»ºä¸å‘å¸ƒ

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: æå–ç‰ˆæœ¬ä¸æ—¶é—´ä¿¡æ¯
      id: get_info
      shell: bash
      run: |
        # 1. ä» Tag æå–ç‰ˆæœ¬å·
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        
        # 2. ç”Ÿæˆä¸‹åˆ’çº¿ç‰ˆæœ¬å·
        VERSION_UNDERSCORE=${VERSION//./_}
        echo "VERSION_UNDERSCORE=$VERSION_UNDERSCORE" >> $GITHUB_ENV
        
        # 3. ç”Ÿæˆæ„å»ºæ—¶é—´ (ä¿®å¤æ—¶åŒºé—®é¢˜)
        # ä½¿ç”¨ Python å¼ºåˆ¶è®¡ç®— UTC+8ï¼Œé¿å¼€ Windows Bash çš„æ—¶åŒº Bug
        BUILD_TIME=$(python -c "import datetime; print((datetime.datetime.now(datetime.timezone.utc) + datetime.timedelta(hours=8)).strftime('%Y-%m-%d %H:%M:%S'))")
        echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_ENV
        
        echo "ğŸš€ å‡†å¤‡æ„å»ºç‰ˆæœ¬: $VERSION"
        echo "ğŸ•’ æ„å»ºæ—¶é—´: $BUILD_TIME (CN)"
        
    - name: è¿è¡Œå‘å¸ƒè„šæœ¬
      env:
        BUILD_VERSION: ${{ env.VERSION }}
      run: python release.py
      
    - name: ä¸Šä¼ ä¾¿æºç‰ˆå‹ç¼©åŒ… (Artifact)
      uses: actions/upload-artifact@v4
      with:
        name: portable-package-v${{ env.VERSION }}
        path: releases/${{ env.VERSION }}/archives/screen_searcher_*.zip
        if-no-files-found: error
        
    - name: åˆ›å»º GitHub Release
      id: create_release
      uses: softprops/action-gh-release@v2
      if: startsWith(github.ref, 'refs/tags/')
      with:
        name: Screen Searcher v${{ env.VERSION }}
        draft: true
        prerelease: false
        generate_release_notes: true
        body: |
          ## ğŸ“¦ Screen Searcher v${{ env.VERSION }} å‘å¸ƒè¯´æ˜
          
          æ„Ÿè°¢ä½¿ç”¨ Screen Searcherï¼
          
          ### ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯
          - **ç‰ˆæœ¬**: v${{ env.VERSION }}
          - **æ„å»ºæ—¶é—´**: ${{ env.BUILD_TIME }} (åŒ—äº¬æ—¶é—´)
          - **Commit**: ${{ github.sha }}
          
          <!-- ä¸‹æ–¹å˜æ›´æ—¥å¿—ç”± GitHub è‡ªåŠ¨ç”Ÿæˆ -->
        files: |
          releases/${{ env.VERSION }}/archives/screen_searcher_*.zip
        token: ${{ secrets.GITHUB_TOKEN }}