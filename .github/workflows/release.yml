name: æ„å»ºä¸å‘å¸ƒ

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€å¸¦æœ‰ v å‰ç¼€çš„æ ‡ç­¾æ—¶è§¦å‘ï¼Œä¾‹å¦‚ v1.0.1

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: æå–ç‰ˆæœ¬å·
      id: get_version
      shell: bash
      run: |
        VERSION=$(cat VERSION)
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "TAG_VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV
        VERSION_UNDERSCORE=${VERSION//./_}
        echo "VERSION_UNDERSCORE=$VERSION_UNDERSCORE" >> $GITHUB_ENV
        
    - name: éªŒè¯ç‰ˆæœ¬å·ä¸€è‡´æ€§
      shell: bash
      run: |
        if [ "$VERSION" != "$TAG_VERSION" ]; then
          echo "é”™è¯¯: æ ‡ç­¾ç‰ˆæœ¬ ($TAG_VERSION) ä¸ VERSION æ–‡ä»¶ä¸­çš„ç‰ˆæœ¬ ($VERSION) ä¸åŒ¹é…"
          exit 1
        fi
        
    - name: è¿è¡Œå‘å¸ƒè„šæœ¬
      run: python release.py
      
    - name: ä¸Šä¼ ä¾¿æºç‰ˆå‹ç¼©åŒ…
      uses: actions/upload-artifact@v4
      with:
        name: portable-package
        path: releases/${{ env.VERSION }}/archives/screen_searcher_v_${{ env.VERSION_UNDERSCORE }}_portable.zip
        
    - name: åˆ›å»º GitHub Release
      id: create_release
      uses: softprops/action-gh-release@v2
      with:
        name: Screen Searcher v${{ env.VERSION }}
        draft: true
        prerelease: false
        generate_release_notes: true
        body: |
          ## ğŸ“¦ Screen Searcher v${{ env.VERSION }} å‘å¸ƒè¯´æ˜
          
          æ„Ÿè°¢ä½¿ç”¨ Screen Searcherï¼
          
          ### ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯
          - ç‰ˆæœ¬: v${{ env.VERSION }}
          - å‘å¸ƒæ—¥æœŸ: ${{ github.event.release.published_at || github.run_started_at }}
          
          <!-- GitHubä¼šæ ¹æ®æäº¤å’ŒPRæ ‡ç­¾è‡ªåŠ¨ç”Ÿæˆå‘å¸ƒè¯´æ˜ -->
        files: |
          releases/${{ env.VERSION }}/archives/screen_searcher_v_${{ env.VERSION_UNDERSCORE }}_portable.zip
        token: ${{ secrets.GITHUB_TOKEN }}