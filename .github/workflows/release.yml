name: æ„å»ºä¸å‘å¸ƒ

on:
  push:
    tags:
      - 'v*'  # ä»…åœ¨æ¨é€ v å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘ï¼Œä¾‹å¦‚ v1.0.1

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip' # ç¡®ä¿æ ¹ç›®å½•ä¸‹æœ‰ requirements.txt ç”¨äºç¼“å­˜
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: æå–ç‰ˆæœ¬ä¸æ—¶é—´ä¿¡æ¯
      id: get_info
      shell: bash
      run: |
        # 1. ä» Tag æå–ç‰ˆæœ¬å· (å»é™¤ v å‰ç¼€)
        # ä¾‹å¦‚ refs/tags/v1.0.1 -> 1.0.1
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        
        # 2. ç”Ÿæˆä¸‹åˆ’çº¿ç‰ˆæœ¬å· (ç”¨äºæ–‡ä»¶å)
        # 1.0.1 -> 1_0_1
        VERSION_UNDERSCORE=${VERSION//./_}
        echo "VERSION_UNDERSCORE=$VERSION_UNDERSCORE" >> $GITHUB_ENV
        
        # 3. ç”Ÿæˆæ„å»ºæ—¶é—´ (è§£å†³åŸæ–‡ä»¶æ—¶é—´ä¸ºç©ºçš„é—®é¢˜)
        # ä½¿ç”¨ date å‘½ä»¤æ‰‹åŠ¨ç”Ÿæˆï¼Œå¹¶æŒ‡å®šä¸ºåŒ—äº¬æ—¶é—´ (Asia/Shanghai)
        BUILD_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')
        echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_ENV
        
        echo "ğŸš€ å‡†å¤‡æ„å»ºç‰ˆæœ¬: $VERSION"
        echo "ğŸ•’ æ„å»ºæ—¶é—´: $BUILD_TIME"
        
    - name: è¿è¡Œå‘å¸ƒè„šæœ¬
      # å°†ç‰ˆæœ¬å·æ³¨å…¥ç¯å¢ƒå˜é‡ï¼Œä¾› release.py è¯»å–å¹¶æ³¨å…¥åˆ° version.py ä¸­
      env:
        BUILD_VERSION: ${{ env.VERSION }}
      run: python release.py
      
    - name: ä¸Šä¼ ä¾¿æºç‰ˆå‹ç¼©åŒ… (Artifact)
      uses: actions/upload-artifact@v4
      with:
        # Artifact åç§°å¸¦ä¸Šç‰ˆæœ¬å·ï¼Œæ–¹ä¾¿åŒºåˆ†
        name: portable-package-v${{ env.VERSION }}
        # ä½¿ç”¨é€šé…ç¬¦ * å¢åŠ å®¹é”™æ€§ï¼Œé˜²æ­¢ Python è„šæœ¬ç”Ÿæˆçš„è·¯å¾„æœ‰ç»†å¾®å·®å¼‚å¯¼è‡´å¤±è´¥
        path: releases/${{ env.VERSION }}/archives/screen_searcher_*.zip
        if-no-files-found: error
        
    - name: åˆ›å»º GitHub Release
      id: create_release
      uses: softprops/action-gh-release@v2
      if: startsWith(github.ref, 'refs/tags/')
      with:
        name: Screen Searcher v${{ env.VERSION }}
        draft: false     # è®¾ç½®ä¸º false ç›´æ¥å‘å¸ƒï¼Œæˆ– true å­˜ä¸ºè‰ç¨¿
        prerelease: false
        generate_release_notes: true
        body: |
          ## ğŸ“¦ Screen Searcher v${{ env.VERSION }} å‘å¸ƒè¯´æ˜
          
          æ„Ÿè°¢ä½¿ç”¨ Screen Searcherï¼
          
          ### ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯
          - **ç‰ˆæœ¬**: v${{ env.VERSION }}
          - **æ„å»ºæ—¶é—´**: ${{ env.BUILD_TIME }} (åŒ—äº¬æ—¶é—´)
          - **Commit**: ${{ github.sha }}
          
          <!-- ä¸‹æ–¹å˜æ›´æ—¥å¿—ç”± GitHub è‡ªåŠ¨ç”Ÿæˆ -->
        files: |
          # ä½¿ç”¨é€šé…ç¬¦ä¸Šä¼  release.py ç”Ÿæˆçš„ zip æ–‡ä»¶
          releases/${{ env.VERSION }}/archives/screen_searcher_*.zip
        token: ${{ secrets.GITHUB_TOKEN }}