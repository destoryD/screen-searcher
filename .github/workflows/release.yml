name: æ„å»ºä¸å‘å¸ƒ

on:
  push:
    tags:
      - 'v*'  # ä»…åœ¨æ¨é€ v å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: ä» Tag æå–ç‰ˆæœ¬å·
      id: get_version
      shell: bash
      run: |
        # GITHUB_REF çš„æ ¼å¼é€šå¸¸æ˜¯ "refs/tags/v1.0.1"
        # ä½¿ç”¨ Shell å‚æ•°æ‰©å±•åŠŸèƒ½ç§»é™¤ "refs/tags/v" å‰ç¼€
        VERSION=${GITHUB_REF#refs/tags/v}
        
        echo "ğŸš€ æ£€æµ‹åˆ° Git Tag ç‰ˆæœ¬: $VERSION"
        
        # å†™å…¥ç¯å¢ƒå˜é‡ VERSION (ä¾‹å¦‚ 1.0.1)
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        
        # ç”Ÿæˆä¸‹åˆ’çº¿ç‰ˆæœ¬ (ä¾‹å¦‚ 1_0_1)ï¼Œç”¨äºæ–‡ä»¶å
        VERSION_UNDERSCORE=${VERSION//./_}
        echo "VERSION_UNDERSCORE=$VERSION_UNDERSCORE" >> $GITHUB_ENV
        
    - name: è¿è¡Œå‘å¸ƒè„šæœ¬
      env:
        BUILD_VERSION: ${{ env.VERSION }}
      run: python release.py
      
    - name: ä¸Šä¼ ä¾¿æºç‰ˆå‹ç¼©åŒ…
      uses: actions/upload-artifact@v4
      with:
        name: portable-package-v${{ env.VERSION }}
        # ä½¿ç”¨é€šé…ç¬¦ *.zip å¢åŠ å®¹é”™æ€§ï¼Œé˜²æ­¢ Python ç”Ÿæˆè·¯å¾„ç»†å¾®å·®å¼‚æŠ¥é”™
        path: releases/${{ env.VERSION }}/archives/screen_searcher_*.zip
        if-no-files-found: error
        
    - name: åˆ›å»º GitHub Release
      id: create_release
      uses: softprops/action-gh-release@v2
      with:
        name: Screen Searcher v${{ env.VERSION }}
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## ğŸ“¦ Screen Searcher v${{ env.VERSION }} å‘å¸ƒè¯´æ˜
          
          æ„Ÿè°¢ä½¿ç”¨ Screen Searcherï¼
          
          ### ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯
          - **ç‰ˆæœ¬**: v${{ env.VERSION }}
          - **æ„å»ºæ—¶é—´**: ${{ github.run_started_at }}
          
          <!-- ä¸‹æ–¹å˜æ›´æ—¥å¿—ç”± GitHub è‡ªåŠ¨ç”Ÿæˆ -->
        files: |
          releases/${{ env.VERSION }}/archives/screen_searcher_*.zip
        token: ${{ secrets.GITHUB_TOKEN }}